<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="../../assets/img/apple-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="../../assets/img/UPDATE 2025 LOGO UniMAP only-01.png"
    />
    <title>UniMAP@KL</title>
    <!--     Fonts and icons     -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900"
    />
    <!-- Nucleo Icons -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <!-- CSS Files -->
    <link
      id="pagestyle"
      href="../../assets/css/material-dashboard.css?v=3.2.0"
      rel="stylesheet"
    />
  </head>

  <body class="g-sidenav-show bg-gray-100">
    <aside
      class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2 bg-white my-2"
      id="sidenav-main"
    >
      <div class="sidenav-header">
        <i
          class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true"
          id="iconSidenav"
        ></i>
        <a class="navbar-brand px-4 py-3 m-0" href="" target="_blank">
          <img
            src="../../assets/img/Logo@kl UniMAP-01.png"
            class="navbar-brand-img"
            width="150"
            height="50"
            alt="main_logo"
          />
        </a>
      </div>
      <hr class="horizontal dark mt-0 mb-2" />
      <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a
              class="nav-link text-dark create-agent-link"
              href="/pages/dashboard-admin.html"
            >
              <i class="material-symbols-rounded opacity-5">dashboard</i>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>

          <li class="nav-item mt-3">
            <h6
              class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder opacity-5"
            >
              Account pages
            </h6>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-dark active bg-gradient-dark text-white sidebar-link dashboard-link"
              href="/pages/admin/create-agent.html"
            >
              <i class="material-symbols-rounded opacity-5">assignment</i>
              <span class="nav-link-text ms-1">Create a new agent</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-dark create-agent-link"
              href="/pages/admin/list-agent.html"
            >
              <i class="material-symbols-rounded opacity-5">assignment</i>
              <span class="nav-link-text ms-1">List of Agent</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-dark create-agent-link"
              href="/pages/admin/application-list.html"
            >
              <i class="material-symbols-rounded opacity-5">assignment</i>
              <span class="nav-link-text ms-1">List of Application</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link text-dark create-agent-link"
              onclick="loadPage('receipt', this)"
            >
              <i class="material-symbols-rounded opacity-5">assignment</i>
              <span class="nav-link-text ms-1">Receipt Payment</span>
            </a>
          </li>
        </ul>
      </div>
      <div class="sidenav-footer position-absolute w-100 bottom-0">
        <div class="mx-3">
          <a
            onclick="signout()"
            class="btn bg-gradient-dark w-100"
            type="button"
            >Sign Out</a
          >
        </div>
      </div>
    </aside>
    <main
      class="main-content position-relative max-height-vh-100 h-100 border-radius-lg"
    >
      <!-- Navbar -->
      <nav
        class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl"
        id="navbarBlur"
        data-scroll="true"
      >
        <div class="container-fluid py-1 px-3">
          <nav aria-label="breadcrumb">
            <ol
              class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5"
            >
              <li class="breadcrumb-item text-sm">
                <a class="opacity-5 text-dark" href="javascript:;">Pages</a>
              </li>
              <li
                class="breadcrumb-item text-sm text-dark active"
                aria-current="page"
              >
                Profile
              </li>
            </ol>
          </nav>
        </div>
      </nav>
      <!-- End Navbar -->
      <form id="uploadForm">
        <div class="container-fluid py-2">
          <div class="row mb-4">
            <div class="ms-3">
              <h3 class="mb-0 h4 font-weight-bolder">Profile</h3>
            </div>
          </div>
          <!-- content -->
          <div class="row mb-4">
            <div id="content">
              <div class="container mt-4">
                <div class="card text-dark">
                  <div class="card-header border-bottom border-secondary">
                    <h5>Create New Agent</h5>
                  </div>
                  <div class="card-body">
                    <!-- Form Fields without <form> tag -->
                    <div class="mb-3 text-left">
                      <label>Upload passport photo sized</label>
                      <!--<img src="../../assets/img/apple-icon.png" alt="Profile Picture" class="rounded-circle mb-3 profile-img">-->
                      <input
                        type="file"
                        class="form-control-file"
                        id="profilePic"
                        accept=".jpg, .jpeg, .png"
                      />
                      <small id="fileHelp" class="form-text text-muted"></small>
                      <!--<br>
              <button type="submit">Upload</button>-->

                      <script>
                        const fileInput = document.getElementById("profilePic");
                        const helpText = document.getElementById("fileHelp");

                        let finalFile = null;

                        fileInput.addEventListener("change", function () {
                          const file = this.files[0];
                          if (!file) return;

                          if (!file.type.startsWith("image/")) {
                            helpText.textContent =
                              "❌ Please upload an image file.";
                            return;
                          }

                          const maxSizeMB = 2;
                          const maxSizeBytes = maxSizeMB * 1024 * 1024;

                          if (file.size > maxSizeBytes) {
                            // Compress image
                            const reader = new FileReader();
                            reader.onload = function (event) {
                              const img = new Image();
                              img.onload = function () {
                                const canvas = document.createElement("canvas");
                                const ctx = canvas.getContext("2d");

                                const scaleFactor = Math.sqrt(
                                  maxSizeBytes / file.size
                                ); // adjust size
                                canvas.width = img.width * scaleFactor;
                                canvas.height = img.height * scaleFactor;

                                ctx.drawImage(
                                  img,
                                  0,
                                  0,
                                  canvas.width,
                                  canvas.height
                                );

                                canvas.toBlob(
                                  function (blob) {
                                    finalFile = new File([blob], file.name, {
                                      type: file.type,
                                    });
                                    helpText.textContent = `✅ Image compressed to ${(
                                      finalFile.size /
                                      1024 /
                                      1024
                                    ).toFixed(2)} MB`;
                                  },
                                  file.type,
                                  0.8
                                ); // 0.8 = quality (80%)
                              };
                              img.src = event.target.result;
                            };
                            reader.readAsDataURL(file);
                          } else {
                            finalFile = file;
                            helpText.textContent =
                              "✅ File is under 2MB, no compression needed.";
                          }
                        });

                        document
                          .getElementById("uploadForm")
                          .addEventListener("submit", function (e) {
                            e.preventDefault();

                            if (!finalFile) {
                              alert("Please select a valid image.");
                              return;
                            }

                            // Upload using FormData (as example)
                            const formData = new FormData();
                            formData.append("file", finalFile);

                            // Simulate upload
                            console.log("Uploading:", finalFile);
                            alert("✅ File ready to upload! (Successfully!)");

                            // You could now use fetch() or AJAX to send `formData` to your backend
                          });
                      </script>
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Full Name</label>
                      <input
                        type="text"
                        class="form-control"
                        id="full_name"
                        placeholder=" Enter Agent full name"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Email Address</label>
                      <input
                        type="email"
                        class="form-control"
                        id="email"
                        placeholder=" Enter your email"
                        style="border: 1px solid #ccc"
                      />
                      <label class="form-label">Contact Number</label>
                      <input
                        type="contact_no"
                        class="form-control"
                        id="contact_no"
                        placeholder=" Enter your Phone Number"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Company Name</label>
                      <input
                        type="text"
                        class="form-control"
                        id="company"
                        placeholder=" Company name"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Company ID</label>
                      <input
                        type="text"
                        class="form-control"
                        id="companyid"
                        placeholder=" Company ID"
                        style="border: 1px solid #ccc"
                      />
                      <label class="form-label">Company Address</label>
                      <input
                        type="text"
                        class="form-control"
                        id="companyAddress"
                        placeholder=" Company Address"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Username</label>
                      <input
                        type="text"
                        class="form-control"
                        id="username"
                        placeholder=" Choose a username"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Password</label>
                      <input
                        type="password"
                        class="form-control"
                        id="password"
                        placeholder=" Create a password"
                        style="border: 1px solid #ccc"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Short Bio</label>
                      <textarea
                        class="form-control"
                        id="bio"
                        rows="2"
                        placeholder="Tell us a little about company..."
                        style="border: 1px solid #ccc"
                      ></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Status</label>
                      <select class="form-select" id="agentStatus">
                        <option value="ACTIVE" selected>ACTIVE</option>
                        <option value="SUSPANDED" selected>SUSPANDED</option>
                        <option value="DEACTIVED" disabled>DEACTIVED</option>
                      </select>
                    </div>
                    <div>
                      <label class="form-label">Remarks</label>
                      <input
                        type="text"
                        class="form-control"
                        id="Remarks"
                        placeholder=" Remarks"
                        style="border: 1px solid #a1a1a1"
                      />
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Role</label>
                      <select class="form-select" id="role">
                        <option value="agent" selected>Agent</option>
                        <option value="admin" disabled>Admin</option>
                      </select>
                    </div>

                    <div class="text-end">
                      <button
                        id="saveUserBtn"
                        type="submit"
                        class="btn btn-success"
                        style="background-color: #333; color: white"
                      >
                        Save
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </main>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const form = document.getElementById("uploadForm");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Collect field values
        const profile_image_ur = document.getElementById("profilePic").files[0];
        const full_name = document.getElementById("full_name").value.trim();
        const email = document.getElementById("email").value.trim();
        const contact_no = document.getElementById("contact_no").value.trim();
        const company_name = document.getElementById("company").value.trim();
        const company_ssm = document.getElementById("companyid").value.trim();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const bio = document.getElementById("bio").value.trim();
        const agent_status = document
          .getElementById("agentStatus")
          .value.trim();
        const agent_remark = document.getElementById("Remarks").value.trim();
        const role = document.getElementById("role")?.value.trim() || null;

        // Validate required fields
        if (
          !full_name ||
          !email ||
          !contact_no ||
          !company_name ||
          !company_SSM ||
          !username ||
          !password ||
          !bio ||
          !agent_status ||
          !agent_remark
        ) {
          alert("Please fill all required fields.");
          return;
        }

        let photoUrl = null;

        // Compress and upload image if exists
        if (passportFile) {
          const finalFile = await compressImage(passportFile);
          const filename = `agents/${Date.now()}_${finalFile.name}`;

          const { data, error } = await supabase.storage
            .from("profile-pictures")
            .upload(filename, finalFile);

          if (error) {
            alert("Failed to upload image.");
            console.error(error);
            return;
          }

          // Get public URL
          const { data: publicUrlData } = supabase.storage
            .from("profile-pictures")
            .getPublicUrl(filename);

          photoUrl = publicUrlData.publicUrl;
        }

        // Insert agent data into table
        const { data: agentData, error: insertError } = await supabase
          .from("agents")
          .insert([
            {
              full_name,
              email,
              contact_no,
              company_name,
              username,
              password,
              bio,
              agent_status,
              agent_remark,
              profile_image_url: photoUrl,
            },
          ]);

        if (insertError) {
          alert("❌ Failed to save agent.");
          console.error(insertError);
          return;
        }

        alert("✅ Agent successfully saved!");
        form.reset();
      });

      // Helper: Compress image if >2MB
      async function compressImage(file) {
        if (file.size <= 2 * 1024 * 1024) return file;

        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              const canvas = document.createElement("canvas");
              const scale = 0.5;
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              canvas.toBlob(
                (blob) => {
                  const compressedFile = new File([blob], file.name, {
                    type: file.type,
                  });
                  resolve(compressedFile);
                },
                file.type,
                0.7
              );
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }
    </script>

    <!--   Core JS Files   -->
    <script src="../../assets/js/core/popper.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="../../assets/js/plugins/smooth-scrollbar.min.js"></script>
    <script src="../../assets/js/plugins/chartjs.min.js"></script>

    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="../../assets/js/material-dashboard.min.js?v=3.2.0"></script>
    <script>
      function signout() {
        // Clear session
        sessionStorage.removeItem("username");
        sessionStorage.removeItem("role");

        // Optional: redirect to login page
        window.location.href = "sign-in.html";
      }
    </script>
    <!-- <script>
      fetch("agent/application-list.html")
        .then((response) => response.text())
        .then((html) => {
          const contentDiv = document.getElementById("content");

          // Create a temporary container
          const temp = document.createElement("div");
          temp.innerHTML = html;

          // Move everything into the target div
          while (temp.firstChild) {
            const child = temp.firstChild;
            // If it's a script, re-insert to run it
            if (child.tagName === "SCRIPT") {
              const newScript = document.createElement("script");
              if (child.src) {
                newScript.src = child.src;
              } else {
                newScript.textContent = child.textContent;
              }
              document.body.appendChild(newScript);
              temp.removeChild(child);
            } else {
              contentDiv.appendChild(child);
            }
          }
        })
        .catch((error) => console.error("Error loading external HTML:", error));
    </script> -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("test");
        const storedLoginDetail = JSON.parse(
          sessionStorage.getItem("loginDetail")
        );
        console.log("test", storedLoginDetail);
        if (storedLoginDetail) {
          document.getElementById("userFullName").innerText =
            storedLoginDetail.full_name;
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="../../assets/js/db/connection.js"></script>
    <script src="../../assets/js/db/fetchApplicationList.js"></script>
    <script src="../../assets/js/db/logout.js"></script>
    <!-- Load Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://bmroymhdqqbzlubpfjvs.supabase.co", // Replace with your Supabase URL
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtcm95bWhkcXFiemx1YnBmanZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NTc4MjMsImV4cCI6MjA2MTAzMzgyM30.k-Vcbza0LeYr9mtQXwD2gHkIys-kmU0uky6VJ0LMX3g" // Replace with your anon key
      );

      document
        .getElementById("saveUserBtn")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("profilePic");
          const file = fileInput.files[0];

          let base64Image = "";
          if (file) {
            base64Image = await toBase64(file);
          }
          function toBase64(file) {
            console.log("hit");
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result); // includes data:image/... prefix
              reader.onerror = (error) => reject(error);
            });
          }
          const user = {
            profile_image_url: base64Image,
            // profilePIc: document.getElementbyId("profilePic").value,
            full_name: document.getElementById("full_name").value,
            email: document.getElementById("email").value,
            phone_number: document.getElementById("contact_no").value,
            company_name: document.getElementById("company").value,
            company_ssm: document.getElementById("companyid").value,
            address: document.getElementById("companyAddress").value,
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            agent_status: document.getElementById("agentStatus").value,
            agent_remark: document.getElementById("Remarks").value,
            bio: document.getElementById("bio").value,
            role: document.getElementById("role").value,
            is_active: true,
            created_at: new Date().toISOString(),
          };
          console.log(user);
          const { data, error } = await supabase.from("user").insert([user]);

          if (error) {
            alert("❌ Error: " + error.message);
            console.error(error);
          } else {
            alert("✅ User created successfully!");
            // Clear fields
            document
              .querySelectorAll("input, textarea")
              .forEach((el) => (el.value = ""));
            document.getElementById("role").value = "agent";
          }
        });
    </script>
  </body>
</html>
